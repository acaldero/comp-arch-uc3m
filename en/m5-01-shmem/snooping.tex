\section{Snooping protocols}

\begin{frame}[t]{Coherence maintenance}
\begin{itemize}
  \item \textgood{Write invalidation}:
    \begin{itemize}
      \item Guarantees that a processor has \textmark{exclusive access} 
            to a block before performing a write.
      \item \textmark{Invalidates} the rest of copies that other processors might have.
    \end{itemize}

  \mode<presentation>{\vfill\pause}
  \item \textgood{Write updates} (\emph{write broadcasting}):
    \begin{itemize}
      \item Broadcasts all writes to \textmark{all caches} to modify block.
      \item Makes use of \textmark{more bandwidth}.
    \end{itemize}

  \mode<presentation>{\vfill\pause}
  \item Most common strategy $\Rightarrow$ \textmark{Invalidation}.
\end{itemize}
\end{frame}

\begin{frame}[t]{Memory bus use}
\begin{itemize}
  \item \textgood{Invalidation}.
    \begin{itemize}
      \item Processor acquires bus and broadcasts the address to be invalidated.
      \item All processors are snooping the bus.
      \item Each processor checks if it has in cache the broadcasted address and invalidate it.
    \end{itemize}

  \mode<presentation>{\vfill\pause}
  \item There cannot be two simultaneous writes:
    \begin{itemize}
      \item Exclusive use of bus serializes writes.
    \end{itemize}

  \mode<presentation>{\vfill\pause}
  \item \textgood{Cache misses}:
    \begin{itemize}
      \item \textmark{Write through}:
        \begin{itemize}
          \item Memory contains the last performed write.
        \end{itemize}
      \item \textmark{Write back}:
        \begin{itemize}
          \item If a processor has a modified copy,
                it sends it to a cache miss from the other processor.
        \end{itemize}
    \end{itemize}
\end{itemize}
\end{frame}

\begin{frame}[t]{Implementation}
\begin{itemize}
  \item \textgood{Invalidation}:
    \begin{itemize}
      \item Takes advantage from \textmark{validity bit} (V) associated to each block.
    \end{itemize}

  \mode<presentation>{\vfill\pause}
  \item \textgood{Writes}:
    \begin{itemize}
      \item Need to know if there are \textmark{other copies} in cache.
        \begin{itemize}
          \item If there are no other copies \textmark{write broadcast} is not needed.
        \end{itemize}

      \mode<presentation>{\vfill\pause}
      \item \textmark{Sharing bit} (S) is added to each associated block.

      \mode<presentation>{\vfill\pause}
      \item When there is a write:
        \begin{itemize}
          \item \textmark{Bus invalidation} is generated.
          \item Transition from \textmark{shared state} to \textmark{exclusive state}.
          \item No need to send new invalidations.
        \end{itemize}

      \mode<presentation>{\vfill\pause}
      \item When there is a \textmark{miss cache} in other processor:
        \begin{itemize}
          \item Transition from \textmark{exclusive state} to \textmark{shared state}.
        \end{itemize}
    \end{itemize}
\end{itemize}
\end{frame}

\begin{frame}[t]{Basic protocol}
\begin{itemize}
  \item Based in \textgood{state machine} for \textmark{each cache block}:
    \begin{itemize}
      \item \textgood{State changes} generated by:
        \begin{itemize}
          \item Processor requests.
          \item Bus requests.
        \end{itemize}
      \item \textgood{Actions}:
        \begin{itemize}
          \item State transitions.
          \item Actions on the bus.
        \end{itemize}
    \end{itemize}

  \mode<presentation>{\vfill\pause}
  \item Simple approach with \textgood{three states}:
    \begin{itemize}
      \item \textmark{M}: Block has been modified.
      \item \textmark{S}: Block is shared.
      \item \textmark{I}: Block has been invalidated.
    \end{itemize}
\end{itemize}
\end{frame}

\begin{frame}[t,shrink=5]{Actions generated by processor}

\makebox[\textwidth][c]
{\scriptsize
\begin{tabular}{l|l|l|l}

Request & State & Action & Description \\
\hline
\hline

\pause Read hit &
S $\rightarrow$ S &
Hit &
Read data from local cache
\\
\hline

\pause Read hit &
M $\rightarrow$ M &
Hit &
Read data from local cache
\\
\hline

\pause Read miss & 
I $\rightarrow$ S&
Miss &
Broadcast read miss on bus.
\\
\hline

\pause Read miss &
S $\rightarrow$ S &
Replacement &
Address conflict miss.
\\

& & &
Broadcast read miss on bus.
\\
\hline

\pause Read miss &
M $\rightarrow$ S &
Replacement &
Address conflict miss.
\\

& & &
Write block and broadcast read miss.
\\
\hline

\pause Write hit &
M $\rightarrow$ M &
Hit&
Write data in local cache.
\\
\hline

\pause Write hit &
S $\rightarrow$ M &
Coherence &
Bus invalidation.
\\
\hline

\pause Write miss &
I $\rightarrow$ M &
Miss &
Broadcast write miss on bus.
\\
\hline

\pause Write miss &
S $\rightarrow$ M &
Replacement &
Address conflict miss. 
\\

& & &
Broadcast write miss on bus.
\\
\hline

\pause Write miss &
M $\rightarrow$ M &
Replacement &
Address conflict miss. 
\\

& & &
Write block and broadcast write miss.
\\
\hline

\end{tabular}
}
\end{frame}


\begin{frame}[t]{MSI Protocol: Processor actions}
\makebox[\textwidth][c]{
\input{en/m5-01-shmem/msi-proc.tkz}
}
\end{frame}


\begin{frame}[t,shrink=5]{Actions generated by bus}

\makebox[\textwidth][c]
{\scriptsize
\begin{tabular}{l|l|l|l}

Request & State & Action & Description\\
\hline
\hline

\pause Read miss &
S $\rightarrow$ S &
-- &
Shared memory serves miss.
\\
\hline

\pause Read miss &
M $\rightarrow$ S &
Coherence &
Attempt to share data.
\\

& & &
Place block on bus.
\\
\hline

\pause Invalidate &
S $\rightarrow$ I &
Coherence &
Attempt to write a shared block.
\\

& & & 
Invalidate block.
\\
\hline

\pause Write miss &
S $\rightarrow$ I &
Coherence &
Attempt to write a shared block.
\\

& & &
Invalidate block.
\\
\hline

\pause Write miss &
M $\rightarrow$ I &
Coherence &
Attempt to write a block that
\\

& & &
is exclusive elsewhere
\\

& & &
Write back cache block.
\\
\hline

\end{tabular}
}
\end{frame}

\begin{frame}[t]{MSI Protocol: Bus actions}
\makebox[\textwidth][c]{
\input{en/m5-01-shmem/msi-bus.tkz}
}
\end{frame}

\begin{frame}[t]{MSI protocol complexities}
\begin{itemize}
  \item Protocol assumes that operations are \textmark{atomic}.
    \begin{itemize}
      \item \textgood{Example}: 
            It is assumed that a miss can be detected, 
            bus acquired, and 
            response received in a single action without interruption.
    \end{itemize}

  \mode<presentation>{\vfill\pause}
  \item If operations are not \textbad{atomic}:
    \begin{itemize}
      \item Possibility for a deadlock or data race.
    \end{itemize}

  \mode<presentation>{\vfill\pause}
  \item \textgood{Solution}:
    \begin{itemize}
      \item Processor sending invalidation keeps
            \textmark{bus ownership} 
            until invalidation arrives to the rest of processors.
    \end{itemize}
\end{itemize}
\end{frame}

\begin{frame}[t]{Extensions to MSI}
\begin{itemize}
  \pause
  \item \textgood{MESI}:
    \begin{itemize}
       \item Add \textmark{exclusive state} (E) signaling
             that a block lives in a single cache but is not modified.
       \item Writing of an \textmark{E} block \textgood{does not generate invalidations}.
    \end{itemize}

  \mode<presentation>{\vfill\pause}
  \item \textgood{MESIF}:
    \begin{itemize}
      \item Adds \textmark{forward state} (F): 
            Alternative to \textmark{S} signaling which node must answer each request.
      \item Used by Intel Core i7.
    \end{itemize}

  \mode<presentation>{\vfill\pause}
  \item \textgood{MOESI}:
    \begin{itemize}
      \item Adds \textmark{owned state} (O) signaling
            that block in memory is not updated.
      \item Avoids memory writes.
      \item Used by AMD Opteron.
    \end{itemize}
\end{itemize}
\end{frame}
